import React, { useState, useMemo, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
  signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously 
} from 'firebase/auth';
import { 
  getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, updateDoc, setDoc, getDoc 
} from 'firebase/firestore';
import { 
  LogOut, Lock, Mail, Zap, History, LayoutDashboard, Target, 
  Bot, Send, X, ShieldCheck, ArrowUpRight, CheckCircle, Wallet, RefreshCcw,
  AlertCircle, Info, Calendar, BarChart3, Edit2, Save, Trash2, TrendingUp, Plus, 
  Euro, Sun, Moon, Database
} from 'lucide-react';

// --- INFRAESTRUCTURA CLOUD ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'lucas-saas-v13';
const apiKey = ""; // Inyectado por el entorno

const App = () => {
  // --- ESTADOS DE SISTEMA ---
  const [user, setUser] = useState(null);
  const [authMode, setAuthMode] = useState('login');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [authError, setAuthError] = useState(null);
  const [loading, setLoading] = useState(true);
  const [isDarkMode, setIsDarkMode] = useState(true);
  
  // --- ESTADOS DE NEGOCIO ---
  const [activeTab, setActiveTab] = useState('operaciones');
  const [rates, setRates] = useState({ bcv: 41.11, binance: 61.30, euro: 44.50 });
  const [expenses, setExpenses] = useState([]);
  const [history, setHistory] = useState([]);
  const [isSavingRates, setIsSavingRates] = useState(false);
  
  // UI Carga
  const [newExpense, setNewExpense] = useState({ name: '', usd: '', type: 'BCV', date: new Date().toISOString().split('T')[0] });
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [chatInput, setChatInput] = useState('');
  const [chatMessages, setChatMessages] = useState([{ role: 'bot', text: 'Sistemas LUCAS en línea. ¿Qué operación procesaremos hoy?' }]);
  const [isTyping, setIsTyping] = useState(false);

  // --- PROTOCOLO DE AUTENTICACIÓN ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Protocolo de acceso fallido:", err); }
      setLoading(false);
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribe();
  }, []);

  // --- SINCRONIZACIÓN Y PERSISTENCIA (REGLA 1 Y 2) ---
  useEffect(() => {
    if (!user || user.isAnonymous) return;
    const userPath = ['artifacts', appId, 'users', user.uid];
    
    // 1. Sincronizar Tasas y Preferencias (Lo que pediste para no perder datos)
    const settingsRef = doc(db, ...userPath, 'settings', 'global');
    getDoc(settingsRef).then(docSnap => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        if (data.rates) setRates(data.rates);
        if (data.theme !== undefined) setIsDarkMode(data.theme);
      }
    });

    // 2. Sincronizar Pendientes
    const unsubExp = onSnapshot(collection(db, ...userPath, 'expenses'), (s) => {
      setExpenses(s.docs.map(d => ({ ...d.data(), id: d.id })));
    });

    // 3. Sincronizar Historial
    const unsubHist = onSnapshot(collection(db, ...userPath, 'history'), (s) => {
      const data = s.docs.map(d => ({ ...d.data(), id: d.id }));
      setHistory(data.sort((a, b) => new Date(b.paidAt) - new Date(a.paidAt)));
    });

    return () => { unsubExp(); unsubHist(); };
  }, [user]);

  // --- ACCIÓN: GUARDAR TASAS AL MOMENTO ---
  const saveGlobalSettings = async (newRates = rates, newTheme = isDarkMode) => {
    if (!user || user.isAnonymous) return;
    setIsSavingRates(true);
    try {
      const settingsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'global');
      await setDoc(settingsRef, { rates: newRates, theme: newTheme, lastUpdate: new Date().toISOString() }, { merge: true });
    } catch (e) { console.error("Error al guardar en el núcleo:", e); }
    setTimeout(() => setIsSavingRates(false), 800);
  };

  // --- LÓGICA DE NEGOCIO ---
  const safeNum = (v) => isNaN(v) || v === null || v === "" ? 0 : parseFloat(v);
  
  const metrics = useMemo(() => {
    const incomeBs = 250 * safeNum(rates.binance);
    const powerUSD = incomeBs / (safeNum(rates.bcv) || 1);
    const totalDebtsBs = expenses.reduce((acc, curr) => {
      const rate = curr.type === 'BINANCE' ? rates.binance : (curr.type === 'EURO' ? rates.euro : rates.bcv);
      return acc + (safeNum(curr.usd) * safeNum(rate));
    }, 0);
    const restaBs = incomeBs - totalDebtsBs;
    return { incomeBs, powerUSD, restaBs, restaUSD: restaBs / (safeNum(rates.bcv) || 1) };
  }, [rates, expenses]);

  // --- IA GEMINI 2.5 FLASH ---
  const callLucasAI = async (message) => {
    setIsTyping(true);
    const prompt = `Eres Lucas, asistente financiero. Extrae: concepto, monto, tasa (BCV/BINANCE/EURO). Responde JSON. Hoy es ${new Date().toLocaleDateString()}.`;
    try {
      const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt + " Usuario: " + message }] }], generationConfig: { responseMimeType: "application/json" } })
      });
      const data = await resp.json();
      return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
    } catch (e) { return { error: "Fallo de conexión neural." }; }
    finally { setIsTyping(false); }
  };

  const handleSendMessage = async () => {
    if (!chatInput.trim()) return;
    const msg = chatInput; setChatInput('');
    setChatMessages(prev => [...prev, { role: 'user', text: msg }]);
    const res = await callLucasAI(msg);
    if (res.error) setChatMessages(prev => [...prev, { role: 'bot', text: res.error }]);
    else setChatMessages(prev => [...prev, { role: 'bot', text: `Detectado: ${res.item} ($${res.monto}) a tasa ${res.tasa}. ¿Lo registro?`, action: res }]);
  };

  const handleAddManual = async () => {
    if (!user || user.isAnonymous || !newExpense.name || !newExpense.usd) return;
    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'expenses'), {
      ...newExpense, usd: safeNum(newExpense.usd), createdAt: new Date().toISOString()
    });
    setNewExpense({ ...newExpense, name: '', usd: '' });
  };

  const markPaid = async (exp) => {
    const rate = exp.type === 'BINANCE' ? rates.binance : (exp.type === 'EURO' ? rates.euro : rates.bcv);
    const month = new Intl.DateTimeFormat('es-ES', { month: 'long' }).format(new Date());
    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'history'), {
      ...exp, paidAt: new Date().toISOString(), appliedRate: rate, monthTag: month
    });
    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'expenses', exp.id));
  };

  const toggleTheme = () => {
    const newTheme = !isDarkMode;
    setIsDarkMode(newTheme);
    saveGlobalSettings(rates, newTheme);
  };

  const handleAuth = async (e) => {
    e.preventDefault(); setLoading(true); setAuthError(null);
    try {
      if (authMode === 'login') await signInWithEmailAndPassword(auth, email, password);
      else await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) { setAuthError("Acceso denegado. Revisa tus credenciales."); }
    setLoading(false);
  };

  if (loading) return (
    <div className={`min-h-screen flex items-center justify-center ${isDarkMode ? 'bg-black text-teal-400' : 'bg-slate-50 text-teal-600'}`}>
      <div className="flex flex-col items-center gap-4">
        <RefreshCcw className="animate-spin" size={40} />
        <span className="font-black tracking-[0.3em] text-xs uppercase">Iniciando Lucas OS...</span>
      </div>
    </div>
  );

  if (!user || user.isAnonymous) return (
    <div className={`min-h-screen flex items-center justify-center p-6 font-sans transition-colors duration-500 ${isDarkMode ? 'bg-black' : 'bg-slate-100'}`}>
      <div className={`${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'} border w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl relative overflow-hidden`}>
        <div className="absolute -top-10 -right-10 opacity-5 text-teal-500 rotate-12"><Database size={240} /></div>
        <header className="text-center mb-10 relative z-10">
          <h1 className={`text-4xl font-black mb-2 tracking-tighter italic ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>LUCAS<span className="text-teal-400">.</span></h1>
          <p className="text-slate-500 text-[10px] font-bold uppercase tracking-[0.4em]">Protocolo de Arbitraje</p>
        </header>
        <form onSubmit={handleAuth} className="space-y-4 relative z-10">
          <input type="email" placeholder="Email Stark" className={`w-full border rounded-2xl py-4 px-6 text-sm outline-none focus:border-teal-400 transition-all ${isDarkMode ? 'bg-black border-slate-800 text-white' : 'bg-slate-50 border-slate-200 text-slate-900'}`} value={email} onChange={e => setEmail(e.target.value)} required />
          <input type="password" placeholder="Clave de Acceso" className={`w-full border rounded-2xl py-4 px-6 text-sm outline-none focus:border-teal-400 transition-all ${isDarkMode ? 'bg-black border-slate-800 text-white' : 'bg-slate-50 border-slate-200 text-slate-900'}`} value={password} onChange={e => setPassword(e.target.value)} required />
          {authError && <p className="text-rose-500 text-[10px] text-center font-black uppercase">{authError}</p>}
          <button className="w-full bg-teal-500 hover:bg-teal-400 py-4 rounded-2xl font-black text-black uppercase shadow-lg transition-all active:scale-95">
            {authMode === 'login' ? 'ACCEDER' : 'RECLUTAR'}
          </button>
        </form>
        <button onClick={() => setAuthMode(authMode === 'login' ? 'register' : 'login')} className="w-full mt-8 text-[10px] text-slate-500 font-bold uppercase hover:text-teal-400 text-center transition-colors">
          {authMode === 'login' ? '¿No tienes cuenta? Crea una' : '¿Ya eres usuario? Login'}
        </button>
      </div>
    </div>
  );

  return (
    <div className={`min-h-screen font-sans transition-colors duration-500 ${isDarkMode ? 'bg-black text-slate-200' : 'bg-slate-50 text-slate-800'}`}>
      
      {/* BARRA DE NAVEGACIÓN PRO */}
      <nav className={`max-w-6xl mx-auto p-4 md:py-8 flex items-center justify-between`}>
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-teal-400 rounded-lg flex items-center justify-center text-black font-black italic shadow-[0_0_15px_rgba(45,212,191,0.5)]">L</div>
          <h2 className={`text-xl font-black tracking-tighter italic ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>LUCAS<span className="text-teal-400">.</span></h2>
        </div>
        
        <div className={`flex gap-1 p-1 rounded-2xl border ${isDarkMode ? 'bg-slate-900/50 border-slate-800' : 'bg-white border-slate-200'} shadow-sm`}>
          {['operaciones', 'historial', 'dashboard'].map(t => (
            <button key={t} onClick={() => setActiveTab(t)} className={`px-5 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${activeTab === t ? 'bg-teal-400 text-black shadow-lg shadow-teal-500/20' : 'text-slate-500 hover:text-teal-400'}`}>{t}</button>
          ))}
        </div>

        <div className="flex items-center gap-3">
          <button onClick={toggleTheme} className={`p-2.5 rounded-xl border transition-all ${isDarkMode ? 'bg-slate-900 border-slate-800 text-yellow-400 hover:bg-slate-800' : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-100'}`}>
            {isDarkMode ? <Sun size={18}/> : <Moon size={18}/>}
          </button>
          <button onClick={() => signOut(auth)} className={`p-2.5 rounded-xl border transition-all ${isDarkMode ? 'bg-slate-900 border-slate-800 text-slate-400 hover:text-rose-500' : 'bg-white border-slate-200 text-slate-400 hover:text-rose-500'}`}><LogOut size={18} /></button>
        </div>
      </nav>

      <main className="max-w-6xl mx-auto px-4 pb-20">
        {activeTab === 'operaciones' && (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-in fade-in slide-in-from-bottom-2 duration-700">
            
            {/* IZQUIERDA: TASAS Y SALDO */}
            <section className="lg:col-span-4 space-y-6">
              <div className="bg-teal-500 p-8 rounded-[2.5rem] text-black shadow-[0_20px_50px_rgba(45,212,191,0.25)] relative overflow-hidden group border border-teal-300/30">
                <ArrowUpRight size={140} className="absolute -right-10 -bottom-10 opacity-10 group-hover:scale-110 transition-transform duration-700" />
                <h3 className="text-[10px] font-black uppercase tracking-widest mb-4 opacity-70 flex items-center gap-2">Saldo Neto Real <div className="w-1.5 h-1.5 bg-black rounded-full animate-pulse"></div></h3>
                <p className="text-6xl font-black tracking-tighter italic">${metrics.restaUSD.toFixed(2)}</p>
                <div className="mt-8 pt-6 border-t border-black/10 flex justify-between items-end">
                   <div>
                     <p className="text-[10px] font-bold uppercase opacity-60">Fondo en Bs.</p>
                     <p className="text-2xl font-black">{metrics.restaBs.toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                   </div>
                   <div className="text-right">
                      <p className="text-[9px] font-black uppercase opacity-60 italic">Bono Arbitraje</p>
                      <p className="text-lg font-black text-black/80">+${(metrics.powerUSD - 250).toFixed(2)}</p>
                   </div>
                </div>
              </div>

              <div className={`${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'} border p-6 rounded-[2.5rem] shadow-xl space-y-5`}>
                 <div className="flex justify-between items-center px-1">
                    <p className="text-[10px] font-black uppercase text-slate-500 tracking-[0.2em] flex items-center gap-2">Monitor de Tasas</p>
                    <button 
                      onClick={() => saveGlobalSettings()} 
                      className={`p-2 rounded-lg transition-all ${isSavingRates ? 'bg-teal-500 text-black' : 'bg-slate-800/20 text-teal-400 hover:bg-teal-500/10'}`}
                      title="Guardar configuracion actual"
                    >
                      {isSavingRates ? <RefreshCcw size={14} className="animate-spin" /> : <Save size={14}/>}
                    </button>
                 </div>
                 {['bcv', 'binance', 'euro'].map(k => (
                   <div key={k} className={`flex justify-between items-center p-3 rounded-2xl border transition-all ${isDarkMode ? 'bg-black/40 border-slate-800 hover:border-teal-500/30' : 'bg-slate-50 border-slate-100 hover:border-teal-500/30'}`}>
                      <span className="text-[10px] font-black uppercase text-slate-500">{k}</span>
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-mono text-slate-600">Bs.</span>
                        <input type="number" value={rates[k]} onChange={e => setRates({...rates, [k]: safeNum(e.target.value)})} className="bg-transparent text-right font-mono font-bold outline-none w-20 text-teal-400 focus:text-teal-300"/>
                      </div>
                   </div>
                 ))}
              </div>
            </section>

            {/* DERECHA: PENDIENTES */}
            <section className={`${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'} lg:col-span-8 border rounded-[3rem] p-8 shadow-2xl flex flex-col`}>
               <div className="flex justify-between items-center mb-10">
                  <h3 className={`text-xs font-black uppercase tracking-widest flex items-center gap-3 ${isDarkMode ? 'text-teal-400' : 'text-slate-900'}`}><Target size={20} className="text-teal-400"/> Objetivos Pendientes</h3>
                  <div className="flex gap-2">
                    <div className={`px-4 py-1.5 rounded-full text-[9px] font-black uppercase border ${isDarkMode ? 'bg-slate-800 border-slate-700 text-slate-400' : 'bg-slate-100 border-slate-200 text-slate-600'}`}>Mes: {new Date().toLocaleString('es-ES', {month: 'long'})}</div>
                  </div>
               </div>
               
               <div className="flex-1 space-y-4 overflow-y-auto max-h-[400px] pr-2 scrollbar-hide">
                 {expenses.length === 0 && (
                   <div className="py-20 text-center">
                     <p className="text-slate-500 text-[10px] font-black uppercase tracking-[0.5em] italic">Bóveda Vacía // Registra Operación</p>
                   </div>
                 )}
                 {expenses.map(e => (
                   <div key={e.id} className={`flex justify-between items-center p-5 rounded-[1.8rem] border transition-all group ${isDarkMode ? 'bg-black/30 border-slate-800 hover:border-teal-500/40' : 'bg-slate-50 border-slate-100 hover:border-teal-500/40'}`}>
                     <div className="flex items-center gap-4">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${e.type === 'BINANCE' ? 'bg-teal-500/10 text-teal-400' : (e.type === 'EURO' ? 'bg-purple-500/10 text-purple-400' : 'bg-blue-500/10 text-blue-400')}`}>
                           {e.type === 'EURO' ? <Euro size={18}/> : <DollarSign size={18}/>}
                        </div>
                        <div>
                          <p className={`font-black text-sm uppercase tracking-tighter ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>{e.name}</p>
                          <div className="flex items-center gap-2 mt-0.5">
                             <span className="text-[8px] font-black uppercase text-slate-500">{new Date(e.createdAt || Date.now()).toLocaleDateString()}</span>
                             <span className={`text-[8px] font-black uppercase px-1.5 py-0.5 rounded ${isDarkMode ? 'bg-slate-800 text-slate-400' : 'bg-white border border-slate-200 text-slate-500'}`}>{e.type}</span>
                          </div>
                        </div>
                     </div>
                     <div className="flex items-center gap-6">
                        <p className={`font-mono font-black text-xl ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>${safeNum(e.usd).toFixed(2)}</p>
                        <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-4 group-hover:translate-x-0">
                           <button onClick={() => markPaid(e)} className="p-3 bg-teal-500/20 text-teal-400 rounded-2xl hover:bg-teal-500 hover:text-black transition-all shadow-lg"><CheckCircle size={20}/></button>
                           <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'expenses', e.id))} className="p-3 bg-rose-500/10 text-rose-500 rounded-2xl hover:bg-rose-500 hover:text-white transition-all"><Trash2 size={20}/></button>
                        </div>
                     </div>
                   </div>
                 ))}
               </div>

               {/* PANEL DE CARGA TURQUESA */}
               <div className={`mt-8 p-6 rounded-[2.2rem] border transition-all ${isDarkMode ? 'bg-black/60 border-slate-800 shadow-inner' : 'bg-slate-50 border-slate-200'}`}>
                  <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <div className="md:col-span-4">
                       <label className="text-[9px] font-black uppercase text-slate-500 ml-2 mb-2 block tracking-widest">Concepto del Gasto</label>
                       <input className={`w-full border rounded-xl px-4 py-3 text-xs outline-none focus:border-teal-400 transition-all ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-900'}`} placeholder="Ej: Pago de Internet" value={newExpense.name} onChange={e => setNewExpense({...newExpense, name: e.target.value})} />
                    </div>
                    <div className="md:col-span-2">
                       <label className="text-[9px] font-black uppercase text-slate-500 ml-2 mb-2 block tracking-widest">Monto $</label>
                       <input className={`w-full border rounded-xl px-4 py-3 text-xs outline-none focus:border-teal-400 transition-all ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-900'}`} type="number" placeholder="0.00" value={newExpense.usd} onChange={e => setNewExpense({...newExpense, usd: e.target.value})} />
                    </div>
                    <div className="md:col-span-3">
                       <label className="text-[9px] font-black uppercase text-slate-500 ml-2 mb-2 block tracking-widest">Fecha Estimada</label>
                       <input type="date" className={`w-full border rounded-xl px-4 py-3 text-[10px] outline-none focus:border-teal-400 transition-all ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-900'}`} value={newExpense.date} onChange={e => setNewExpense({...newExpense, date: e.target.value})} />
                    </div>
                    <div className="md:col-span-2">
                       <label className="text-[9px] font-black uppercase text-slate-500 ml-2 mb-2 block tracking-widest">Tasa</label>
                       <select className={`w-full border rounded-xl px-3 py-3 text-xs outline-none appearance-none cursor-pointer focus:border-teal-400 transition-all ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-900'}`} value={newExpense.type} onChange={e => setNewExpense({...newExpense, type: e.target.value})}>
                         <option value="BCV">Oficial BCV</option>
                         <option value="BINANCE">P2P Binance</option>
                         <option value="EURO">Oficial Euro</option>
                       </select>
                    </div>
                    <div className="md:col-span-1">
                       <button onClick={handleAddManual} className="w-full bg-teal-500 hover:bg-teal-400 text-black rounded-xl py-3 flex justify-center shadow-lg transition-transform active:scale-95"><Plus size={20}/></button>
                    </div>
                  </div>
               </div>
            </section>
          </div>
        )}

        {/* HISTORIAL: AUDITORÍA TEMPORAL */}
        {activeTab === 'historial' && (
          <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
             <div className={`${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'} border rounded-[2.5rem] overflow-hidden shadow-2xl`}>
                <div className="p-6 border-b border-slate-800 flex justify-between items-center bg-teal-400/5">
                   <h3 className="text-xs font-black uppercase tracking-widest text-teal-400 italic flex items-center gap-2"><History size={18}/> Auditoría Central</h3>
                   <div className="flex items-center gap-2">
                      <span className="w-2 h-2 bg-teal-500 rounded-full animate-pulse"></span>
                      <span className="text-[9px] text-slate-500 font-black uppercase tracking-widest">Registros Cloud</span>
                   </div>
                </div>
                <div className="overflow-x-auto">
                   <table className="w-full text-left">
                      <thead>
                        <tr className="text-[10px] uppercase text-slate-600 border-b border-slate-800/50 font-black">
                           <th className="p-6">Transacción / Fecha</th>
                           <th className="p-6 text-center">Periodo</th>
                           <th className="p-6 text-right">Monto USD</th>
                           <th className="p-6 text-right">Tasa de Cierre</th>
                           <th className="p-6"></th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-800/30">
                        {history.length === 0 ? (
                          <tr><td colSpan="5" className="p-24 text-center text-slate-700 uppercase font-black text-xs tracking-widest italic opacity-40">Archivo de Datos Vacío.</td></tr>
                        ) : (
                          history.map(h => (
                            <tr key={h.id} className={`transition-colors group ${isDarkMode ? 'hover:bg-slate-800/40' : 'hover:bg-slate-50'}`}>
                               <td className="p-6">
                                  <p className={`font-black text-sm uppercase tracking-tighter ${isDarkMode ? 'text-slate-200' : 'text-slate-900'}`}>{h.name}</p>
                                  <p className="text-[9px] text-slate-500 font-mono mt-1 uppercase italic">{new Date(h.paidAt).toLocaleString()}</p>
                               </td>
                               <td className="p-6 text-center">
                                  <span className={`text-[9px] px-3 py-1 rounded-full font-black uppercase tracking-widest border ${isDarkMode ? 'bg-slate-800 border-slate-700 text-slate-400' : 'bg-slate-100 border-slate-200 text-slate-500'}`}>{h.monthTag}</span>
                               </td>
                               <td className="p-6 text-right font-mono font-black text-teal-400 text-lg">${safeNum(h.usd).toFixed(2)}</td>
                               <td className="p-6 text-right font-mono text-slate-500 text-xs">{safeNum(h.appliedRate).toFixed(2)} Bs.</td>
                               <td className="p-6 text-right">
                                  <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'history', h.id))} className="p-2 text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={16}/></button>
                               </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                   </table>
                </div>
             </div>
          </div>
        )}

        {/* DASHBOARD: MANTENIMIENTO DE ARMADURA */}
        {activeTab === 'dashboard' && (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8 animate-in zoom-in duration-500">
             <div className={`${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'} md:col-span-2 border p-10 rounded-[3rem] shadow-2xl relative overflow-hidden`}>
                <div className="absolute top-0 right-0 p-8 opacity-5 text-teal-400"><BarChart3 size={150}/></div>
                <h3 className={`text-xs font-black uppercase tracking-widest mb-12 flex items-center gap-3 ${isDarkMode ? 'text-teal-400' : 'text-slate-900'}`}>Health Check de la Bóveda</h3>
                <div className="flex flex-col md:flex-row gap-12 items-center">
                   <div className="relative w-56 h-56 group">
                      <div className="absolute inset-0 bg-teal-400/20 blur-3xl rounded-full group-hover:bg-teal-400/30 transition-all"></div>
                      <svg className="w-full h-full transform -rotate-90 relative z-10">
                         <circle cx="112" cy="112" r="100" stroke="currentColor" strokeWidth="16" fill="transparent" className={isDarkMode ? 'text-slate-800' : 'text-slate-100'} />
                         <circle cx="112" cy="112" r="100" stroke="currentColor" strokeWidth="16" fill="transparent" strokeDasharray={628} strokeDashoffset={628 - (628 * (history.reduce((a,c)=>a+safeNum(c.usd),0)/250))} className="text-teal-400" strokeLinecap="round" />
                      </svg>
                      <div className="absolute inset-0 flex flex-col items-center justify-center relative z-20">
                         <span className={`text-5xl font-black italic ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>{((history.reduce((a,c)=>a+safeNum(c.usd),0)/250)*100).toFixed(0)}%</span>
                         <span className="text-[9px] text-slate-500 uppercase font-black tracking-widest mt-1">Presupuesto OK</span>
                      </div>
                   </div>
                   <div className="flex-1 space-y-6 w-full relative z-10">
                      <div className="group">
                         <div className="flex justify-between items-end border-b border-slate-800 pb-2 transition-all group-hover:border-teal-400/50">
                            <span className="uppercase text-[10px] font-black text-slate-500 tracking-widest">Ingreso Nominal</span>
                            <span className={`font-black ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>$250.00</span>
                         </div>
                      </div>
                      <div className="group">
                         <div className="flex justify-between items-end border-b border-slate-800 pb-2 transition-all group-hover:border-teal-400/50">
                            <span className="uppercase text-[10px] font-black text-teal-400 tracking-widest">Poder Real Mercado</span>
                            <span className="font-black text-teal-400">${metrics.powerUSD.toFixed(2)}</span>
                         </div>
                      </div>
                      <div className="group">
                         <div className="flex justify-between items-end border-b border-slate-800 pb-2 transition-all group-hover:border-teal-400/50">
                            <span className="uppercase text-[10px] font-black text-teal-500 tracking-widest">Ahorro Neto Arbitraje</span>
                            <span className="font-black text-teal-500">Bs. {(history.reduce((acc,curr) => acc + (safeNum(curr.usd) * rates.binance) - (safeNum(curr.usd) * curr.appliedRate), 0)).toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                         </div>
                      </div>
                   </div>
                </div>
             </div>
             <div className="bg-gradient-to-br from-teal-950/40 to-black border border-teal-500/20 p-10 rounded-[3rem] shadow-xl flex flex-col justify-between group">
                <div className="space-y-6">
                   <h3 className="text-xs font-black text-teal-400 uppercase tracking-widest">System Status</h3>
                   <div className="flex items-center gap-4">
                      <div className="w-12 h-12 bg-teal-500/10 rounded-2xl flex items-center justify-center text-teal-400 shadow-inner group-hover:scale-110 transition-transform"><ShieldCheck size={24}/></div>
                      <div>
                         <p className="text-[10px] font-black text-slate-500 uppercase">Cloud Security</p>
                         <p className={`text-sm font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Sincronizado</p>
                      </div>
                   </div>
                </div>
                <div className={`p-5 rounded-3xl border transition-all ${isDarkMode ? 'bg-slate-900 border-slate-800 text-slate-400' : 'bg-white border-slate-200 text-slate-600'}`}>
                   <p className="text-[10px] leading-relaxed font-black uppercase italic">"Bray, cada operación procesada fortalece el núcleo de Lucas. El arbitraje es la mejor arma contra el caos cambiario."</p>
                </div>
             </div>
          </div>
        )}
      </main>

      {/* CHATBOT IA LUCAS: PROTOCOLO JARVIS */}
      <div className="fixed bottom-8 right-8 z-50">
        {!isChatOpen ? (
          <button 
            onClick={() => setIsChatOpen(true)} 
            className="w-16 h-16 bg-teal-400 rounded-full flex items-center justify-center shadow-[0_0_25px_rgba(45,212,191,0.6)] hover:scale-110 transition-all text-black border-4 border-black group"
          >
            <Bot size={30} className="group-hover:rotate-12 transition-transform duration-500"/>
          </button>
        ) : (
          <div className={`w-80 sm:w-96 h-[520px] border shadow-2xl rounded-[2.5rem] flex flex-col overflow-hidden animate-in slide-in-from-bottom-8 duration-500 ${isDarkMode ? 'bg-slate-950 border-slate-800' : 'bg-white border-slate-200'}`}>
            <header className="bg-teal-400 p-5 text-black flex justify-between items-center shadow-lg relative z-10">
               <div className="flex items-center gap-3">
                 <div className="p-2 bg-black rounded-lg text-teal-400"><Zap size={18} fill="currentColor"/></div>
                 <span className="text-xs font-black uppercase tracking-widest">Lucas AI Assistant</span>
               </div>
               <button onClick={() => setIsChatOpen(false)} className="hover:scale-125 transition-all"><X size={20}/></button>
            </header>
            <div className={`flex-1 p-5 overflow-y-auto space-y-4 scrollbar-hide ${isDarkMode ? 'bg-black/40' : 'bg-slate-50'}`}>
               {chatMessages.map((m, i) => (
                 <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                   <div className={`max-w-[85%] p-4 rounded-[1.5rem] text-xs shadow-md ${m.role === 'user' ? 'bg-teal-500 text-black font-black uppercase italic' : (isDarkMode ? 'bg-slate-900 text-slate-300 border border-slate-800' : 'bg-white text-slate-700 border border-slate-200')} leading-relaxed`}>
                     {m.text}
                     {m.action && <button onClick={() => handleConfirmAi(m.action)} className="mt-4 block w-full bg-teal-400 text-black py-3 rounded-2xl font-black uppercase text-[10px] hover:bg-white hover:shadow-teal-400/20 transition-all">Confirmar en el Núcleo</button>}
                   </div>
                 </div>
               ))}
               {isTyping && <div className="text-[10px] text-teal-400 font-black uppercase animate-pulse flex items-center gap-2"><RefreshCcw size={12} className="animate-spin"/> Lucas está procesando datos...</div>}
            </div>
            <div className={`p-4 border-t flex gap-3 ${isDarkMode ? 'bg-black/60 border-slate-800' : 'bg-white border-slate-200'}`}>
               <input className={`flex-1 rounded-2xl px-5 py-3 text-xs outline-none transition-all ${isDarkMode ? 'bg-slate-900 border-slate-800 text-white focus:border-teal-400' : 'bg-slate-100 border-slate-100 text-slate-900 focus:border-teal-400'}`} placeholder="Ej: 'Debo 15 de luz'..." value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleSendMessage()} />
               <button onClick={handleSendMessage} className="p-3 bg-teal-400 text-black rounded-2xl shadow-lg active:scale-90 transition-all"><Send size={20}/></button>
            </div>
          </div>
        )}
      </div>

      <footer className={`max-w-6xl mx-auto py-10 border-t text-center text-[10px] font-black uppercase tracking-[0.6em] italic transition-colors ${isDarkMode ? 'border-slate-900 text-slate-800' : 'border-slate-200 text-slate-300'}`}>
        LUCAS OS v13.0 // Cyber-Turquoise // @SoyBrayAI
      </footer>
    </div>
  );
};

export default App;
